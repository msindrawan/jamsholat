<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Sholat Lampung</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #f3e5f5 100%);
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .prayer-card {
            transition: all 0.3s ease;
        }
        .prayer-card.active {
            background: linear-gradient(to right, #81c784, #4db6ac);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(77, 182, 172, 0.3);
        }
        .prayer-card.passed {
            opacity: 0.6;
            background-color: rgba(200, 200, 200, 0.2);
        }
        /* Custom Date Picker Styling */
        input[type="date"] {
            background: transparent;
            font-family: inherit;
            color: inherit;
            cursor: pointer;
        }
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>
<body class="text-gray-700 pb-10">

    <div class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-white/30 overflow-hidden">
        
        <!-- Header -->
        <header class="pt-8 pb-6 px-6 text-center">
            <h1 class="text-2xl font-bold text-teal-700 mb-1">Jadwal Sholat</h1>
            <p class="text-sm text-gray-500 mb-4">Wilayah Provinsi Lampung (2026)</p>
        </header>

        <!-- Controls Section (Location & Date) -->
        <div class="px-6 mb-6 space-y-3">
            <!-- Location Selector -->
            <div class="relative">
                <i class="ph ph-map-pin absolute left-3 top-1/2 transform -translate-y-1/2 text-teal-500"></i>
                <select id="city-selector" class="w-full pl-10 pr-4 py-3 rounded-2xl glass-panel appearance-none focus:outline-none focus:ring-2 focus:ring-teal-300 text-sm font-medium cursor-pointer shadow-sm">
                    <option value="">Memuat Daftar Kota...</option>
                </select>
                <i class="ph ph-caret-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Date Selector -->
            <div class="flex items-center gap-3">
                <div class="relative flex-1">
                    <i class="ph ph-calendar-blank absolute left-3 top-1/2 transform -translate-y-1/2 text-teal-500"></i>
                    <input type="date" id="date-picker" class="w-full pl-10 pr-4 py-3 rounded-2xl glass-panel focus:outline-none focus:ring-2 focus:ring-teal-300 text-sm font-medium shadow-sm uppercase text-gray-600">
                </div>
            </div>
            
            <!-- Date Display Group -->
            <div class="mt-3 text-center">
                <!-- Masehi -->
                <div id="date-display-text" class="inline-block text-xs font-bold text-teal-700 bg-white/50 px-3 py-1 rounded-full shadow-sm">
                    Memuat tanggal...
                </div>
                <!-- Hijriah -->
                <div id="hijri-date-display" class="block text-sm font-medium text-teal-600 mt-1 italic">
                    ...
                </div>
            </div>
        </div>

        <!-- Countdown Section -->
        <div class="px-6 mb-8">
            <div class="glass-panel rounded-3xl p-6 text-center shadow-lg relative overflow-hidden group">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-300 to-purple-300"></div>
                
                <p class="text-xs font-semibold tracking-wider uppercase text-gray-500 mb-1">Menuju Waktu</p>
                <h2 id="next-prayer-name" class="text-2xl font-bold text-teal-700 mb-2">...</h2>
                
                <div class="text-4xl font-mono font-bold text-gray-800 tracking-tight" id="countdown-timer">
                    --:--:--
                </div>
                
                <div class="mt-3 text-xs text-gray-500 flex justify-center items-center gap-1">
                    <i class="ph ph-clock"></i> <span id="current-time">00:00:00 WIB</span>
                </div>
            </div>
        </div>

        <!-- Prayer List -->
        <div class="px-6 space-y-3" id="schedule-list">
            <!-- Cards will be injected here via JS -->
            <div class="text-center py-10 text-gray-400">
                <i class="ph ph-spinner animate-spin text-2xl"></i>
                <p class="text-sm mt-2">Menghubungkan ke server Aladhan...</p>
            </div>
        </div>

        <!-- Footer / Credits -->
        <footer class="mt-10 px-6 text-center pb-6">
            <div class="text-xs text-gray-500 p-4 rounded-xl border border-dashed border-gray-300 bg-white/20 mb-4">
                <p class="font-semibold mb-1">Referensi Data:</p>
                <p>Aladhan API (Metode Kemenag RI)</p>
                <p class="italic mt-2">"Sesungguhnya shalat itu adalah fardhu yang ditentukan waktunya atas orang-orang yang beriman." (QS. An-Nisa: 103)</p>
            </div>
            
            <!-- Developer Credit -->
            <div class="text-xs font-medium text-teal-700">
                Dikembangkan oleh Sani ibnu Sofyan
            </div>
        </footer>

    </div>

    <script>
        // --- Configuration & State ---
        // Metode 20 = Kemenag RI (Standard Indonesia)
        const API_BASE = 'https://api.aladhan.com/v1/timings';
        
        // Data Koordinat 15 Kabupaten/Kota di Lampung
        const LAMPUNG_CITIES = [
            { name: "Kota Bandar Lampung", lat: -5.4294, long: 105.2625 },
            { name: "Kota Metro", lat: -5.1131, long: 105.3045 },
            { name: "Kab. Lampung Barat (Liwa)", lat: -5.0358, long: 104.0456 },
            { name: "Kab. Lampung Selatan (Kalianda)", lat: -5.7267, long: 105.5897 },
            { name: "Kab. Lampung Tengah (Gunung Sugih)", lat: -4.9569, long: 105.2106 },
            { name: "Kab. Lampung Timur (Sukadana)", lat: -5.0747, long: 105.5344 },
            { name: "Kab. Lampung Utara (Kotabumi)", lat: -4.8239, long: 104.8833 },
            { name: "Kab. Way Kanan (Blambangan Umpu)", lat: -4.5025, long: 104.5244 },
            { name: "Kab. Tulang Bawang (Menggala)", lat: -4.4756, long: 105.2392 },
            { name: "Kab. Pesawaran (Gedong Tataan)", lat: -5.4128, long: 105.1064 },
            { name: "Kab. Pringsewu", lat: -5.3622, long: 104.9750 },
            { name: "Kab. Mesuji", lat: -3.8825, long: 105.3536 },
            { name: "Kab. Tulang Bawang Barat", lat: -4.4361, long: 105.0347 },
            { name: "Kab. Pesisir Barat (Krui)", lat: -5.1953, long: 103.9317 },
            { name: "Kab. Tanggamus (Kota Agung)", lat: -5.4967, long: 104.6225 }
        ];

        let currentSchedule = {};
        let selectedCityIndex = localStorage.getItem('selectedCityIndex'); 
        let countdownInterval;
        
        // --- Elements ---
        const citySelector = document.getElementById('city-selector');
        const datePicker = document.getElementById('date-picker');
        const dateDisplayText = document.getElementById('date-display-text');
        const hijriDateDisplay = document.getElementById('hijri-date-display');
        const scheduleList = document.getElementById('schedule-list');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const currentTimeEl = document.getElementById('current-time');

        // --- Icons Mapping ---
        const prayerIcons = {
            'Imsak': 'ph-moon-stars',
            'Fajr': 'ph-cloud-sun',      // Subuh
            'Sunrise': 'ph-sun-horizon', // Terbit
            'Duha': 'ph-sun',            // Dhuha
            'Dhuhr': 'ph-sun-dim',       // Dzuhur
            'Asr': 'ph-cloud-sun',       // Ashar
            'Maghrib': 'ph-cloud-moon',  // Maghrib (Updated to Cloud Moon)
            'Isha': 'ph-moon'            // Isya
        };

        // --- Initialization ---
        async function init() {
            try {
                updateClock();
                setInterval(updateClock, 1000);
                
                // Set Default Date (Today)
                const today = new Date();
                datePicker.valueAsDate = today;
                updateDateDisplayText(today);

                populateCities();
                
                // Handle saved location vs default
                if(selectedCityIndex === null || selectedCityIndex === undefined || selectedCityIndex >= LAMPUNG_CITIES.length) {
                    // Coba temukan index Kota Bandar Lampung di array yang sudah di-sort
                    const bandarLampungIndex = LAMPUNG_CITIES.findIndex(c => c.name === "Kota Bandar Lampung");
                    // Jika ketemu gunakan indexnya, jika tidak gunakan index 0
                    selectedCityIndex = bandarLampungIndex !== -1 ? bandarLampungIndex : 0;
                }
                
                citySelector.value = selectedCityIndex;
                
                // Load Schedule
                await loadSchedule(selectedCityIndex, today);

                // Event Listeners
                datePicker.addEventListener('change', (e) => {
                    const newDate = e.target.valueAsDate;
                    if(newDate) {
                        updateDateDisplayText(newDate);
                        loadSchedule(selectedCityIndex, newDate);
                    }
                });
            } catch (error) {
                console.error("Initialization Error:", error);
                scheduleList.innerHTML = `<div class="text-red-500 text-center p-4">Error aplikasi: ${error.message}</div>`;
            }
        }

        // --- Populate Cities ---
        function populateCities() {
            // Sort Alphabetical
            LAMPUNG_CITIES.sort((a, b) => a.name.localeCompare(b.name));

            citySelector.innerHTML = '';
            LAMPUNG_CITIES.forEach((city, index) => {
                const option = document.createElement('option');
                option.value = index; 
                option.textContent = city.name;
                citySelector.appendChild(option);
            });

            citySelector.addEventListener('change', (e) => {
                selectedCityIndex = e.target.value;
                localStorage.setItem('selectedCityIndex', selectedCityIndex);
                loadSchedule(selectedCityIndex, datePicker.valueAsDate);
            });
        }

        // --- Load Schedule (Aladhan API) ---
        async function loadSchedule(cityIdx, dateObj) {
            if (!dateObj) dateObj = new Date();
            const city = LAMPUNG_CITIES[cityIdx];
            if (!city) return;

            try {
                scheduleList.innerHTML = `
                    <div class="py-8 text-center animate-pulse">
                        <div class="h-4 bg-gray-300 rounded w-3/4 mx-auto mb-2"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2 mx-auto"></div>
                        <p class="text-xs text-gray-400 mt-2">Menghitung waktu sholat...</p>
                    </div>`;

                // Format Tanggal: DD-MM-YYYY
                const dd = String(dateObj.getDate()).padStart(2, '0');
                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                const yyyy = dateObj.getFullYear();
                const dateStr = `${dd}-${mm}-${yyyy}`;

                const url = `${API_BASE}/${dateStr}?latitude=${city.lat}&longitude=${city.long}&method=20`;
                
                const response = await fetch(url);
                const result = await response.json();

                if (result.code === 200 && result.data) {
                    if(result.data.date && result.data.date.hijri) {
                         const h = result.data.date.hijri;
                         hijriDateDisplay.textContent = `${h.day} ${h.month.en} ${h.year}`;
                    }
                    
                    currentSchedule = result.data.timings;
                    
                    // Logic Dhuha: Jika tidak ada, pakai Syuruq + 20 menit
                    if (currentSchedule.Sunrise && !currentSchedule.Duha) {
                        currentSchedule.Duha = addMinutes(currentSchedule.Sunrise, 20); 
                    }

                    renderCards(currentSchedule, dateObj);
                } else {
                    scheduleList.innerHTML = '<div class="text-center text-red-500 p-4">Jadwal tidak tersedia dari API.</div>';
                }
            } catch (error) {
                console.error(error);
                scheduleList.innerHTML = '<div class="text-center text-red-500 p-4">Gagal memuat data. Periksa koneksi internet.</div>';
            }
        }

        // --- Render UI Cards ---
        function renderCards(timings, selectedDate) {
            scheduleList.innerHTML = '';
            
            const keysToDisplay = [
                { key: 'Fajr', label: 'Subuh' },
                { key: 'Sunrise', label: 'Syuruq' },
                { key: 'Duha', label: 'Dhuha' },
                { key: 'Dhuhr', label: 'Dzuhur' },
                { key: 'Asr', label: 'Ashar' },
                { key: 'Maghrib', label: 'Maghrib' },
                { key: 'Isha', label: 'Isya' }
            ];

            const now = new Date();
            
            keysToDisplay.forEach((item) => {
                let timeStrRaw = timings[item.key] || timings[item.label];
                if (!timeStrRaw) return;
                
                // Ambil HH:mm
                const timeStr = timeStrRaw.substring(0, 5);
                const timeObj = getPrayerDateObject(timeStr, selectedDate);
                const isPassed = now > timeObj;
                
                let cardClass = "glass-panel rounded-2xl p-4 flex items-center justify-between prayer-card cursor-default";
                let iconClass = `ph ${prayerIcons[item.key] || 'ph-clock'} text-2xl`;

                const div = document.createElement('div');
                div.className = cardClass;
                div.dataset.time = timeObj.getTime();
                div.dataset.name = item.label;

                if (isPassed) {
                   div.classList.add('passed');
                }
                
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-white/50 flex items-center justify-center text-teal-600 shadow-sm">
                            <i class="${iconClass}"></i>
                        </div>
                        <span class="font-bold text-lg">${item.label}</span>
                    </div>
                    <span class="font-mono font-semibold text-xl tracking-wide">${timeStr}</span>
                `;

                scheduleList.appendChild(div);
            });
            
            determineNextPrayer(selectedDate);
        }

        // --- Logic: Countdown ---
        function determineNextPrayer(selectedDate) {
            const now = new Date();
            const cards = document.querySelectorAll('.prayer-card');
            let nextPrayerTime = null;
            let nextPrayerName = "";

            cards.forEach(c => c.classList.remove('active'));

            for (let card of cards) {
                const pTime = parseInt(card.dataset.time);
                const pName = card.dataset.name;
                
                if (pTime > now.getTime()) {
                    nextPrayerTime = pTime;
                    nextPrayerName = pName;
                    card.classList.add('active');
                    break;
                }
            }

            // --- PERBAIKAN LOGIKA: Handle Next Day Subuh ---
            if (!nextPrayerTime) {
                const isToday = isSameDay(selectedDate, now);
                
                // Jika hari ini dan Isya sudah lewat, targetkan Subuh Besok
                if (isToday) {
                    // Ambil waktu Subuh (Fajr) dari jadwal hari ini sebagai estimasi
                    // (Biasanya selisih hanya +/- 1 menit)
                    const subuhRaw = currentSchedule['Fajr'] || currentSchedule['Subuh'];
                    
                    if (subuhRaw) {
                        const subuhTimeStr = subuhRaw.substring(0, 5);
                        
                        // Buat objek tanggal untuk Besok
                        const tomorrow = new Date(now);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        
                        const tomorrowSubuhTime = getPrayerDateObject(subuhTimeStr, tomorrow);
                        
                        nextPrayerNameEl.textContent = "Subuh (Besok)";
                        startCountdown(tomorrowSubuhTime.getTime(), selectedDate);
                        return; // Keluar dari fungsi agar tidak masuk blok 'else'
                    }
                } 
                
                // Jika tanggal yang dipilih sudah lewat (kemarin dst)
                else if (selectedDate < now && !isToday) {
                    nextPrayerNameEl.textContent = "Waktu Berlalu";
                    countdownTimerEl.textContent = "00:00:00";
                    return;
                }
            }

            if (nextPrayerTime) {
                nextPrayerNameEl.textContent = nextPrayerName;
                startCountdown(nextPrayerTime, selectedDate);
            }
        }

        function startCountdown(targetTime, selectedDate) {
            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetTime - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownTimerEl.textContent = "00:00:00";
                    nextPrayerNameEl.textContent = "Waktunya Sholat!";
                    // Refresh UI untuk update status card
                    setTimeout(() => loadSchedule(selectedCityIndex, selectedDate), 1000);
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                countdownTimerEl.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- Helpers ---
        function updateDateDisplayText(dateObj) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateDisplayText.textContent = dateObj.toLocaleDateString('id-ID', options);
        }

        function getPrayerDateObject(timeStr, dateContext) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date(dateContext);
            date.setHours(hours, minutes, 0, 0);
            return date;
        }

        function addMinutes(timeStr, minutesToAdd) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes + minutesToAdd);
            return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        }

        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
        }

        function updateClock() {
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' WIB';
        }

        init();
    </script>
</body>
</html>


